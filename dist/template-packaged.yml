AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Globals:
  Function:
    Timeout: 30
    Runtime: python3.8
    Handler: app.lambda_handler
Resources:
  InputQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 30
      QueueName: event-processor-queue-main
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
          - DeadLetterQueue
          - Arn
        maxReceiveCount: 2
  DeadLetterQueue:
    Type: AWS::SQS::Queue
    Properties:
      VisibilityTimeout: 30
      QueueName: event-processor-queue-dlq
  Processor:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: event-processor
      CodeUri: s3://event-processor-sqs/e41fe6fb98606eca98a9a91898079efe
      Policies:
      - AmazonSQSFullAccess
      Events:
        SqsEvent:
          Type: SQS
          Properties:
            Queue:
              Fn::GetAtt:
              - InputQueue
              - Arn
            BatchSize: 1
            Enabled: true
